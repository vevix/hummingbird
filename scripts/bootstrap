#!/bin/bash

# Build files
docker-compose build
# Install dependencies
docker-compose run -d --entrypoint=bundle server install
docker-compose run -d --entrypoint=npm client install
docker-compose run -d --entrypoint=bower client install --allow-root
# Initialize database
docker-compose run -d server rake db:setup
# Boot app
# TODO: Runs prior to detached tasks above finishing
docker-compose up -d

# Get docker-machine ip if there is one
# TODO: `localhost` on Mac, `docker` on Windows
port="$(docker-compose port nginx 80 | cut -d: -f2)"
[ -z "$DOCKER_MACHINE_NAME" ] && host='localhost' || host="$(docker-machine ip $DOCKER_MACHINE_NAME)"
server="http://$host:$port"

echo "Server listening on $server"

if [[ $* == *-o* ]]; then
  # We try a multitude of ways to open the browser.  Should usually succeed.
  if [ -n $BROWSER ]; then
    $BROWSER $server
  elif which open > /dev/null; then
    open $server
  elif which xdg-open > /dev/null; then
    xdg-open $server
  elif which python > /dev/null; then
    python -mwebbrowser $server
  else
    echo "Could not detect the web browser to use."
  fi
fi
